<html>
<head><meta charset="UTF-8" />
<title>websocket ruby test</title>
<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.3.min.js"></script> 
<script type="text/javascript">
var json_data_buffer = {};
var json_data_all_buffer = [];
var now_event = "all";
var index = null;
$(function(){
    var ws = new WebSocket('ws://localhost:6557/socket');                                                                                                

    $("#trace").on('click', function(){
		var realtime = $('input:radio[name="realtime"]:checked').val()
		if (realtime === "realtime") return;
		var event = $('input:radio[name="event"]:checked').val()
		if (now_event !== event) {
			now_event = event;
			index = null;
		}
		var check_json = {}
		if (event === "all") {
			check_json = json_data_all_buffer;
		} else {
			check_json = json_data_buffer[event];
		}
		if (index === null) {
			index = check_json.length - 1;
		} else {
			if (realtime === "backtrace") {
				index -= 1;
				if (index < 0) index = 0;
			} else {
				index += 1;
				if (check_json.length  <= index) index = check_json.length - 1;
			}
		}
        $("#msg-area").text(JSON.stringify(check_json[index], null,"\t"));
		$("#index").text(`index:${index}`);
		var json_time = new Date(check_json[index].time);
		$("#time").text("Event Time:" + json_time.toString());
    });

    ws.onmessage = function(event){
		var json = event.data.replace(/([,{}])/g, "$1\n");
		var json_data = JSON.parse(json);
		if (typeof json_data_buffer[json_data.event] === "undefined") json_data_buffer[json_data.event] = [];
		var realtime = $('input:radio[name="realtime"]:checked').val()
		var event = $('input:radio[name="event"]:checked').val()
		if (realtime === "realtime" && (event === "all" || json_data.event === event)) {
	        $("#msg-area").text(JSON.stringify(json_data, null,"\t"));
			var json_time = new Date(json_data.time);
			$("#time").text("Event Time:" + json_time.toString());
		}
		if (typeof json_data.status !== "undefined" && json_data.status !== null) {
			if (typeof json_data.status.beatmap !== "undefined" && json_data.status.beatmap !== null) {
				json_data.status.beatmap.songCover = "!DELETE!(http_statsu_check.html)";
			}
		}
		json_data_buffer[json_data.event].push(json_data);
		json_data_all_buffer.push(json_data);
		// console.log(JSON.stringify(json_data, null,"\t"));
    };
});
</script>
</head>
<body>
<H1>Beat Saber HTTP Status Checker</H1>
<hr>
<input type="radio" name="realtime" value="realtime" checked/>Realtime
<input type="radio" name="realtime" value="backtrace"/>Back Trace
<input type="radio" name="realtime" value="forwardtrace"/>Forward Trace
<input type="button" id="trace" value="trace"/>
<hr>
<table>
	<tr>
		<td><input type="radio" name="event" value="all" checked/>all</td>
	</tr>
	<tr>
		<td><input type="radio" name="event" value="hello"/>hello</td>
		<td><input type="radio" name="event" value="songStart"/>songStart</td>
		<td><input type="radio" name="event" value="finished"/>finished</td>
		<td><input type="radio" name="event" value="softFailed"/>softFailed</td>
		<td><input type="radio" name="event" value="menu"/>menu</td>
	</tr>
	<tr>
		<td><input type="radio" name="event" value="pause"/>pause</td>
		<td><input type="radio" name="event" value="resume"/>resume</td>
		<td><input type="radio" name="event" value="noteCut"/>noteCut</td>
		<td><input type="radio" name="event" value="noteFullyCut"/>noteFullyCut</td>
		<td><input type="radio" name="event" value="noteMissed"/>noteMissed</td>
	</tr>
	<tr>
		<td><input type="radio" name="event" value="bombCut"/>bombCut</td>
		<td><input type="radio" name="event" value="bombMissed"/>bombMissed</td>
		<td><input type="radio" name="event" value="obstacleEnter"/>obstacleEnter</td>
		<td><input type="radio" name="event" value="scoreChanged"/>scoreChanged</td>
		<td><input type="radio" name="event" value="beatmapEvent"/>beatmapEvent</td>
	</tr>
</table>
<hr>
<pre id="index"></pre>
<pre id="time"></pre>
<pre id="msg-area"></pre>
</body>
</html>
